<!doctype html>
<html lang="vi">
    <head>
    <title>
         PrintNightmare của letsdefend challenge | ctnguyenvn 
    </title>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <meta property="og:description" content="Xin chào, bài viết này chia sẻ về thử thách PrintNightmare được cung cấp bới Bohan Zhang tại đây

Thông tin:


  Our system exploited by PrintNightmare vulnerability. You should investigate the case.
  pcap/memory file: download / pass: infected
  Công cụ sử dụng: Brim / Wireshark / Redline


Trước khi đi qua từng câu hỏi tôi xin đề cập trước rằng bối cảnh của bài này có thể là attacker đã khai thác thành công và tất cả những gì chúng ta cần truy vết là những gì sau đó.

Sau khi tải file được cung cấp và giải nén ta được một số file quan trọng gồm:


  AnalysisSession1.mans -&gt; Analysis session mở với Redline
  challenge-v1.pcapng -&gt; Traffic giữa attacker với nạn nhân
  suricata.rules -&gt; rule alert của suricata với lỗ hỗng PrintNightmare


" />
    
    <meta name="author" content="ctnguyenvn" />
    
    <meta property="og:title" content="PrintNightmare của letsdefend challenge - Happy Investigating" />
    <meta property="twitter:title" content="PrintNightmare của letsdefend challenge - Happy Investigating" />
     
    <meta property="og:image" content="https://ctnguyenvn.github.io/assets/img/ctnguyenvn.webp" />
    <meta property="twitter:image" content="https://ctnguyenvn.github.io/assets/img/ctnguyenvn.webp" />
    
    <meta property="og:site_name" content="ctnguyenvn - System security" />
    <!-- <link rel="stylesheet" type="text/css" href="https://ctnguyenvn.github.io/assets/css/bulma.min.css" /> -->
	<script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://ctnguyenvn.github.io/assets/css/styles.css" />
    <link rel="stylesheet" type="text/css" href="https://ctnguyenvn.github.io/assets/css/highlight.css" />
    <link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet" />
    <link
        rel="alternate"
        type="application/rss+xml"
        title=" - Happy Investigating"
        href="https://ctnguyenvn.github.io/feed.xml"
    />
    <link rel="canonical" href="https://ctnguyenvn.github.io/2022/12/investigate-printNightmare/" />
    <meta name="theme-color" content="#000000" />
    <link rel="icon" type="image/png" sizes="32x32" href="https://ctnguyenvn.github.io/assets/img/ctnguyenvn.png" />
        
</head>

    <body>
		<div>
			<div class="border-b"><nav class="max-w-screen-lg mx-auto flex justify-between items-center p-4">
    <div class="">
        <a href="https://ctnguyenvn.github.io">
            <img src="https://ctnguyenvn.github.io/assets/img/ctnguyenvn.png" class="h-6" alt="ctnguyenvn" />
        </a>
    </div>
    <div class="hidden md:flex justify-center gap-6">
        <a href="/" class="text-xs font-medium uppercase px-2 hover:text-yellow-400">Home</a>
        <a href="/" class="text-xs font-medium uppercase px-2 hover:text-yellow-400">Blog</a>
        <a href="/projects" class="text-xs font-medium uppercase px-2 hover:text-yellow-400">Projects</a>
        <a href="/about" class="text-xs font-medium uppercase px-2 hover:text-yellow-400">About</a>
    </div>
    <div class="flex gap-4">
        <a href="https://github.com/ctnguyenvn" class="hover:text-yellow-400">
            <i class="bi bi-github"></i>
        </a>
        <a href="https://twitter.com/ctnguyenvn" class="hover:text-yellow-400">
            <i class="bi bi-twitter"></i>
        </a>
        <a href="https://t.me/ctnguyenvn" class="hover:text-yellow-400">
            <i class="bi bi-telegram"></i>
        </a>
    </div>
</nav>
</div>
			<main><div class="max-w-screen-lg mx-auto my-2 py-2 md:my-6 md:py-6 px-4">
    <div class="text-center pt-4">
        <p>
             
            <a class="text-sm bg-yellow-300 px-2 py-1 rounded px mx-1 hover:opacity-90" href="/tag/games">Games</a>
             
            <a class="text-sm bg-yellow-300 px-2 py-1 rounded px mx-1 hover:opacity-90" href="/tag/forensic">Forensic</a>
             
        </p>
        <h1 class="text-4xl font-semibold pt-1 pb-2">
            <a href="/2022/12/investigate-printNightmare/" class="is-size-3 has-text-black-ter has-text-weight-semibold">PrintNightmare của letsdefend challenge</a>
        </h1>
        <div class="text-md pt-1">
            <span class="text-gray-400">Posted by</span>
            <a href="https://ctnguyenvn.github.io/about" class="text-[#007cc3]">ctnguyenvn</a>
            <span class="text-gray-400">on</span>
            <i class="bi bi-clock px-1 text-gray-400 text-sm"></i>
            <span class="text-[#007cc3]">25 December, 2022</span>
        </div>
    </div>
    <div class="content my-4 py-4"><p>Xin chào, bài viết này chia sẻ về thử thách PrintNightmare được cung cấp bới <a href="https://www.linkedin.com/in/bohan-zhang-078751137/">Bohan Zhang</a> tại <a href="https://app.letsdefend.io/challenge/PrintNightmare">đây</a></p>

<p>Thông tin:</p>

<ul>
  <li>Our system exploited by PrintNightmare vulnerability. You should investigate the case.</li>
  <li>pcap/memory file: <a href="https://api.letsdefend.io/download/downloadfile/PrintNightmare.zip">download</a> / pass: infected</li>
  <li>Công cụ sử dụng: Brim / Wireshark / Redline</li>
</ul>

<p>Trước khi đi qua từng câu hỏi tôi xin đề cập trước rằng bối cảnh của bài này có thể là attacker đã khai thác thành công và tất cả những gì chúng ta cần truy vết là những gì sau đó.</p>

<p>Sau khi tải file được cung cấp và giải nén ta được một số file quan trọng gồm:</p>

<ul>
  <li>AnalysisSession1.mans -&gt; Analysis session mở với Redline</li>
  <li>challenge-v1.pcapng -&gt; Traffic giữa attacker với nạn nhân</li>
  <li>suricata.rules -&gt; rule alert của suricata với lỗ hỗng PrintNightmare</li>
</ul>

<!--more-->

<h4 id="looking-through-the-alerts-in-brim-what-is-the-vulnerability-name-and-its-corresponding-cve">Looking through the alerts in Brim, what is the vulnerability name and its corresponding CVE?</h4>

<p>Tại câu này chỉ cần xem rule alert của suricata sẽ thấy nội dung được đề cập trong msg</p>

<p><img src="/images/PrintNightmare/2.png" alt="" /></p>

<blockquote>
  <p>sloved: {printnightmare, cve-2021-34527}</p>
</blockquote>

<h4 id="what-is-attackers-ip">What is Attacker’s IP?</h4>

<p>Mở file pcap được cung cấp tôi chỉ thấy có mỗi 2 IP gồm 10.10.10.2 và 10.10.10.4, paste một trong hai IP này kiểu gì cũng đúng :)). Đùa thôi, như ban đầu đã đề cập tôi suy đoán rằng attacker khai thác victim và bắt đầu share file để tải dll độc hại về. Như vậy IP attacker sẽ là server share file (server) và victim sẽ đóng vai trò download file, tiếp tục kiểm tra traffic tôi thấy địa chỉ 10.10.10.4 request đến 10.10.10.2 một file có tên là <code class="language-plaintext highlighter-rouge">notsostealthy.dll</code></p>

<p><img src="/images/PrintNightmare/3.png" alt="" /></p>

<p>Như vậy có thể khẳng định IP của attacker là 10.10.10.2</p>

<blockquote>
  <p>sloved: {10.10.10.2}</p>
</blockquote>

<h4 id="what-is-attackers-share-path">What is Attacker’s share path?</h4>

<p>Sử dụng Wireshark hoặc Brim tôi có thể dể dàng thấy đường dẫn share folder</p>

<p><img src="/images/PrintNightmare/4.png" alt="" /></p>

<blockquote>
  <p>sloved: {\\10.10.10.2\share}</p>
</blockquote>

<h4 id="what-is-the-name-of-the-malicious-dll-file-hosted-by-the-attacker">What is the name of the malicious DLL file hosted by the attacker?</h4>

<p>Như hình trên chúng ta cũng thấy tên file dll victim đã tải về <code class="language-plaintext highlighter-rouge">notsostealthy.dll</code></p>

<blockquote>
  <p>sloved: {notsostealthy.dll}</p>
</blockquote>

<h4 id="what-is-the-sha256-hash-of-the-dll-file">What is the sha256 hash of the DLL file?</h4>

<p>Mở pcap với wireshark sau đó File -&gt; Export Objects -&gt; SMB tôi tải các file dll về và check sẽ được SHA256. Tuy nhiên lưu ý dll tại packet 165 hoặc 228 mới là dll đúng.</p>

<p><img src="/images/PrintNightmare/5.png" alt="" /></p>

<blockquote>
  <p>sloved: {fa1ee835869ea97559359568043aea3a52508b360cfc5195a3d7fbb60cef55a5}</p>
</blockquote>

<h4 id="what-is-the-email-address-used-for-the-self-signed-ssl-certificate-in-the-traffic">What is the email address used for the self-signed SSL Certificate in the traffic?</h4>

<p>Tìm kiếm ssl trên wireshark có thể thấy tại packet 245 (server hello) chứa email được sử dụng khi establed connection</p>

<p><img src="/images/PrintNightmare/6.png" alt="" /></p>

<blockquote>
  <p>sloved: {override@shields.mertz.net}</p>
</blockquote>

<h4 id="what-is-the-domain-user-used-by-the-attacker-to-exploit-the-vulnerability">What is the domain user used by the attacker to exploit the vulnerability?</h4>

<p>Ở câu này tôi có thể sử dụng Redline hoặc wireshark để tìm thông tin tài khoản được attacker sử dụng. Trên wireshark tìm kiếm ssl và tôi thấy tại packet 65 (session setup request) cung cấp thông tin user xác thực cho quá trình thiết lập share SMB.</p>

<p><img src="/images/PrintNightmare/7.png" alt="" /></p>

<blockquote>
  <p>sloved: {bellybear\jesse.harmon}</p>
</blockquote>

<h4 id="what-is-the-exploit-servers-hostname">What is the exploit server’s hostname?</h4>

<p>Trên wireshark tìm kiếm smb2 và tôi có thể thấy thông tin Hostname của server attacker</p>

<p><img src="/images/PrintNightmare/8.png" alt="" /></p>

<blockquote>
  <p>sloved: {WIN-FLO4EU2VMSM}</p>
</blockquote>

<h4 id="what-is-the-username-created-by-the-attacker-for-persistence">What is the username created by the attacker for persistence?</h4>

<p>Ở câu này tôi có thể tìm kiếm dựa trên event log hoặc đơn giản chọn user -&gt; và tìm kiếm user nghi ngờ.</p>

<p><img src="/images/PrintNightmare/9.png" alt="" /></p>

<blockquote>
  <p>sloved: {hacker}</p>
</blockquote>

<h4 id="what-is-the-event-id-for-user-creation-in-windows-and-when-was-the-user-being-created">What is the event ID for user creation in Windows, and when was the user being created?</h4>

<p>Như câu trên đề cập, tôi chọn Eventlog và tìm kiếm event id 4720 (created user). Kết quả có 5 event match và tìm kiếm event id 4720 với user được tạo là <code class="language-plaintext highlighter-rouge">hacker</code></p>

<p><img src="/images/PrintNightmare/10.png" alt="" /></p>

<blockquote>
  <p>sloved: {4720, 2021-08-16 19:31:46z}</p>
</blockquote>

<h4 id="what-process-name-is-used-to-establish-the-shell-connection-between-the-attackers-machine-and-the-windows-server-and-what-is-the-listening-port-on-the-attackers-machine">What process name is used to establish the shell connection between the attacker’s machine and the Windows server? and what is the listening port on the attacker’s machine?</h4>

<p>Sử dụng Redline, chọn Ports -&gt; Established Ports kết quả chỉ có 1 connection với thông tin cần tìm</p>

<p><img src="/images/PrintNightmare/11.png" alt="" /></p>

<blockquote>
  <p>sloved: {rundll32.exe, 443}</p>
</blockquote>

<h4 id="the-attacker-used-a-famous-post-exploitation-framework-to-create-the-dll-file-and-establish-the-shell-connection-to-the-windows-server-what-is-the-payload-the-attacker-used">The attacker used a famous post-exploitation framework to create the DLL file and establish the shell connection to the Windows server, what is the payload the attacker used?</h4>

<p>Ở câu này có vẻ hơi mông lung, post-exploitation framework được sử dụng phổ biến có lẽ là với metasploit còn establish shell với window thì sau một hồi google search lòng vòng và thử một vài payloads thì kết quả là payload <code class="language-plaintext highlighter-rouge">windows/x64/meterpreter/reverse_https</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>search reverse_https <span class="nb">type</span>:payload platform:window
</code></pre></div></div>

<p><img src="/images/PrintNightmare/12.png" alt="" /></p>

<blockquote>
  <p>sloved: {windows/x64/meterpreter/reverse_https}</p>
</blockquote>

<h4 id="the-attacker-left-a-text-file-for-the-user-administrator-can-you-find-what-the-filename-is">The attacker left a text file for the user Administrator, can you find what the filename is?</h4>

<p>Cuối cùng trên Redline chọn File System tôi thấy file nghi ngờ được attacker để lại tại thư mục C:\Users\Administrator\Documents với tên <code class="language-plaintext highlighter-rouge">This-Is-Really-A-Nightmare.txt</code></p>

<p><img src="/images/PrintNightmare/13.png" alt="" /></p>

<blockquote>
  <p>sloved: {This-Is-Really-A-Nightmare.txt}</p>
</blockquote>

<h3 id="summary">Summary</h3>

<p>Lỗ hỗng <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527">PrintNightmare</a> là lỗ hỗng trên Windows Print Spooler cho phép kẻ tấn công sau khi khai thác thành công có thể chạy mã tùy ý với đặc quyền hệ thống. Sau đó chúng có thể cài đặt chương trình; xem, thay đổi hoặc xóa dữ liệu; hoặc tạo tài khoản mới với đầy đủ quyền của người dùng,…</p>
</div>
    <div class="gap-2 my-4">
        <a href="https://twitter.com/intent/tweet?text=PrintNightmare của letsdefend challenge&url=https://ctnguyenvn.github.io/2022/12/investigate-printNightmare/" class="px-2 py-1 rounded bg-gray-800 hover:bg-yellow-400"><i class="bi bi-twitter-x text-gray-200 hover:text-gray-800"></i></a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=https://ctnguyenvn.github.io/2022/12/investigate-printNightmare/" class="px-2 py-1 rounded bg-gray-800 hover:bg-yellow-400"><i class="bi bi-facebook text-gray-200 hover:text-gray-800"></i></a>
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ctnguyenvn.github.io/2022/12/investigate-printNightmare/&title=PrintNightmare của letsdefend challenge=&source=ctnguyenvn" class="px-2 py-1 rounded bg-gray-800 hover:bg-yellow-400"><i class="bi bi-linkedin text-gray-200 hover:text-gray-800"></i></a>
        <a href="https://reddit.com/submit?url=https://ctnguyenvn.github.io/2022/12/investigate-printNightmare/&title=PrintNightmare của letsdefend challenge" class="px-2 py-1 rounded bg-gray-800 hover:bg-yellow-400"><i class="bi bi-reddit text-gray-200 hover:text-gray-800"></i></a>
    </div>
    <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        this.page.url = 'https://ctnguyenvn.github.io/2022/12/investigate-printNightmare/';
        this.page.identifier = 'ctnguyenvn';
    };
    (function () {
        var d = document,
            s = d.createElement('script');
        s.src = 'https://ctnguyenvn.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>

</div>
</main>
			<div class="border-t bg-black">
<div class="max-w-screen-xl mx-auto flex flex-col px-2 py-6 text-center">
    <p class="text-gray-300">
        <strong>@2024</strong>
        by
        <a href="/" class="hover:text-yellow-400">ctnguyenvn</a>
        /
        <a href="/tags" class="hover:text-yellow-400">Tags</a>
        /
        <a href="/archive" class="hover:text-yellow-400">Archive</a>
    </p>
</div>
</div>
		</div>
        <script src="https://ctnguyenvn.github.io/assets/js/custom.js"></script>
    </body>
</html>
